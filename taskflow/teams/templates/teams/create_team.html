{% extends "base.html" %}
{% load form_tags %}
{% block title %}{{ title }} | {{ block.super }}{% endblock %}
{% load static %}

{% block content %}

<div class="container mx-auto px-4 sm:px-6 lg:px-8">
  <form method="post" action=".">
    {% csrf_token %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="md:col-span-1">
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg h-full">
          <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white">General</h3>
            <div class="flex space-x-2">
              <button type="button" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-white"
                data-card-widget="collapse" title="Collapse">
                <i class="fas fa-minus"></i>
              </button>
            </div>
          </div>
          <div class="p-6 space-y-4">
            <div>
              <label for="inputName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Team Name</label>
              {{ form.name|add_class:"w-full bg-gray-100 border border-gray-300 rounded-md py-2 px-3 text-gray-700 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" }}
            </div>
            <div>
              <label for="inputDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Team Description</label>
              {{ form.description|add_class:"w-full bg-gray-100 border border-gray-300 rounded-md py-2 px-3 text-gray-700 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" }}
            </div>
            <div>
              <label for="inputName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Team Lead</label>
              {{ form.team_lead|add_class:"w-full bg-gray-100 border border-gray-300 rounded-md py-2 px-3 text-gray-700 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" }}
            </div>
            <div>
              <label for="id_members"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Members</label>
              <div class="relative" id="members-dropdown-container">
                <div class="hidden">
                  {{ form.members }}
                </div>
                <div
                  class="w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md py-2 px-3 min-h-[42px] flex flex-wrap gap-2 items-center cursor-text focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent transition-all duration-200"
                  id="members-selection-box">
                  <input type="text" id="members-search" placeholder="Select members..."
                    class="bg-transparent border-none focus:ring-0 p-0 text-sm text-gray-700 dark:text-gray-200 flex-1 min-w-[120px] outline-none placeholder-gray-500 dark:placeholder-gray-400">
                </div>
                <div id="members-options"
                  class="absolute z-20 mt-1 w-full bg-white dark:bg-gray-800 shadow-xl max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm hidden border border-gray-100 dark:border-gray-700">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit/Cancel Buttons at the Bottom -->
    <div class="mt-6">
      <div class="flex justify-between">
        <a href="javascript:window.history.back()"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</a>
        <input type="submit"
          value="{% if request.resolver_match.url_name == 'create' %}Create Team{% else %}Update Team {{request.resolver_match.url_name}}{% endif %}"
          class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block script %}
{{ block.super }}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('members-dropdown-container');
    const hiddenSelect = container.querySelector('select');
    const selectionBox = document.getElementById('members-selection-box');
    const searchInput = document.getElementById('members-search');
    const optionsList = document.getElementById('members-options');

    let options = Array.from(hiddenSelect.options).map(opt => ({
      value: opt.value,
      text: opt.text,
      selected: opt.selected
    }));

    function render() {
      const existingTags = selectionBox.querySelectorAll('.member-tag');
      existingTags.forEach(tag => tag.remove());

      options.filter(o => o.selected).forEach(opt => {
        const tag = document.createElement('div');
        tag.className = 'member-tag bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs font-medium px-2.5 py-0.5 rounded-full flex items-center gap-1';
        tag.innerHTML = `
          <span>${opt.text}</span>
          <button type="button" class="text-blue-600 dark:text-blue-300 hover:text-blue-800 dark:hover:text-blue-100 focus:outline-none" data-value="${opt.value}">
            <i class="fas fa-times"></i>
          </button>
        `;
        selectionBox.insertBefore(tag, searchInput);
      });

      optionsList.innerHTML = '';
      const filter = searchInput.value.toLowerCase();
      const filteredOptions = options.filter(o => !o.selected && o.text.toLowerCase().includes(filter));

      if (filteredOptions.length === 0) {
        const noResult = document.createElement('div');
        noResult.className = 'px-4 py-2 text-sm text-gray-500 dark:text-gray-400 cursor-default select-none';
        noResult.textContent = 'No members found';
        optionsList.appendChild(noResult);
      } else {
        filteredOptions.forEach(opt => {
          const div = document.createElement('div');
          div.className = 'cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-blue-50 dark:hover:bg-gray-700 text-gray-900 dark:text-white';
          div.innerHTML = `<span class="block truncate font-normal">${opt.text}</span>`;
          div.addEventListener('click', () => toggleSelection(opt.value));
          optionsList.appendChild(div);
        });
      }

      Array.from(hiddenSelect.options).forEach(opt => {
        const optionData = options.find(o => o.value === opt.value);
        opt.selected = optionData.selected;
      });
    }

    function toggleSelection(value) {
      const opt = options.find(o => o.value === value);
      if (opt) {
        opt.selected = !opt.selected;
        searchInput.value = '';
        render();
        if (opt.selected) {
          searchInput.focus();
        }
      }
    }

    selectionBox.addEventListener('click', (e) => {
      if (e.target.closest('button')) {
        const btn = e.target.closest('button');
        toggleSelection(btn.dataset.value);
      } else {
        searchInput.focus();
        optionsList.classList.remove('hidden');
      }
    });

    searchInput.addEventListener('input', () => {
      optionsList.classList.remove('hidden');
      render();
    });

    searchInput.addEventListener('focus', () => {
      optionsList.classList.remove('hidden');
      render();
    });

    document.addEventListener('click', (e) => {
      if (!container.contains(e.target)) {
        optionsList.classList.add('hidden');
      }
    });

    render();
  });
</script>
{% endblock %}